<!-- Floating Microblog Button -->
<button id="microblog-toggle-btn" class="microblog-fab microblog-fab-top" aria-label="Open Microblog" onclick="document.getElementById('microblog-panel').classList.add('open'); this.style.display='none';">ðŸ’¬ Microblog</button>

<!-- Microblog Side Panel -->
<aside id="microblog-panel" class="microblog-panel" tabindex="-1" aria-label="Microblog panel">
  <div class="microblog-panel-header">
    <button id="microblog-close-btn" class="microblog-close-btn" aria-label="Close Microblog" onclick="document.getElementById('microblog-panel').classList.remove('open'); document.getElementById('microblog-toggle-btn').style.display='';">&times;</button>
    <h2 class="microblog-panel-title">Microblog</h2>
    <button id="guest-signup-toggle" class="guest-signup-toggle-btn">Guest Signup</button>
  </div>

  <!-- Guest Signup Form -->
  <div id="guest-signup-form" class="guest-signup-container" style="display: none;">
    <h3 class="guest-signup-title">Quick Guest Signup</h3>
    <form id="guest-form" onsubmit="handleGuestSignup(event);">
      <div class="guest-form-group">
        <input type="text" id="guest-username" placeholder="Username" required>
      </div>
      <div class="guest-form-group">
        <input type="password" id="guest-password" placeholder="Password" required>
      </div>
      <p>
        <button type="submit" class="guest-submit-btn">Sign Up & Login</button>
      </p>
      <p id="guest-status-message" class="guest-status"></p>
    </form>
  </div>

  <div class="microblog-panel-content">
    <div id="microblog-playground">
      <em>Loading microblog posts...</em>
    </div>
  </div>
</aside>

<!-- Create/Edit Modal -->
<div id="microblog-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="microblog-modal-panel">
    <div class="microblog-modal-header">
      <button id="modal-close" class="microblog-modal-close" aria-label="Close Modal">&times;</button>
      <h2 id="modal-title" class="microblog-modal-title">Create Microblog Post</h2>
    </div>
    <form id="microblog-form" class="space-y-4">
      <input type="hidden" id="post-id" name="id">
      <div>
        <label class="block text-sm font-medium text-gray-700">Topic</label>
        <input id="topic-id" name="topicId" type="text" class="mt-1 block w-full border border-gray-300 rounded-md p-2" readonly>
      </div>
      <div class="microblog-form-group">
        <label for="content" class="microblog-form-label">Content <span class="required">*</span></label>
        <textarea id="content" name="content" required class=""></textarea>
      </div>
      <div class="flex justify-end space-x-2">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
(async function() {
  const pythonURI = window.pythonURI || 'http://localhost:8303';
  const MICROBLOG_API = `${pythonURI}/api/microblog/posts`;
  const pagePermalink = '{{page.permalink}}';
  
  if (document.readyState === 'loading') {
    await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
  }
  
  // Guest signup toggle
  const guestSignupToggle = document.getElementById('guest-signup-toggle');
  const guestSignupForm = document.getElementById('guest-signup-form');
  
  if (guestSignupToggle) {
    guestSignupToggle.onclick = function() {
      guestSignupForm.style.display = guestSignupForm.style.display === 'none' ? 'block' : 'none';
    };
  }
  
  // Guest signup handler
  window.handleGuestSignup = async function(event) {
    event.preventDefault();
    const username = document.getElementById('guest-username').value;
    const password = document.getElementById('guest-password').value;
    const statusMessage = document.getElementById('guest-status-message');
    const submitButton = document.querySelector('.guest-submit-btn');

    submitButton.disabled = true;
    submitButton.textContent = 'Creating Account...';

    try {
      await fetch(`${pythonURI}/api/user/guest`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid: username, password: password })
      });

      const loginResponse = await fetch(`${pythonURI}/api/authenticate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ uid: username, password: password })
      });

      if (!loginResponse.ok) throw new Error('Login failed');
      
      statusMessage.textContent = 'Success! You are now logged in.';
      statusMessage.style.color = 'green';

      setTimeout(() => {
        guestSignupForm.style.display = 'none';
        document.getElementById('guest-username').value = '';
        document.getElementById('guest-password').value = '';
        submitButton.disabled = false;
        submitButton.textContent = 'Sign Up & Login';
      }, 2000);

    } catch (error) {
      statusMessage.textContent = `Error: ${error.message}`;
      statusMessage.style.color = 'red';
      submitButton.disabled = false;
      submitButton.textContent = 'Sign Up & Login';
    }
  };
  
  // Modal functions
  function openModal({ mode, post = {} }) {
    document.getElementById('microblog-modal').classList.remove('hidden');
    document.getElementById('modal-title').textContent = mode === 'edit' ? 'Edit Microblog Post' : 'Create Microblog Post';
    document.getElementById('post-id').value = post.id || '';
    document.getElementById('topic-id').value = post.topicPath || pagePermalink;
    document.getElementById('content').value = post.content || '';
  }
  
  function closeModal() {
    document.getElementById('microblog-modal').classList.add('hidden');
  }
  
  document.getElementById('modal-close').onclick = closeModal;
  document.getElementById('microblog-modal').onclick = function(e) {
    if (e.target === this) closeModal();
  };
  
  // Form submission
  document.getElementById('microblog-form').onsubmit = async function(e) {
    e.preventDefault();
    const id = document.getElementById('post-id').value;
    const topicPath = document.getElementById('topic-id').value;
    const content = document.getElementById('content').value;
    
    try {
      let url = MICROBLOG_API;
      let method = 'POST';
      
      if (id) {
        url += `/${id}`;
        method = 'PUT';
      }
      
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ content, page_context: topicPath })
      });
      
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      closeModal();
      await renderMicroblogTable();
      
    } catch (err) {
      alert('Error saving post: ' + err.message);
    }
  };
  
  // Render table
  async function renderMicroblogTable() {
    const container = document.getElementById('microblog-playground');
    
    try {
      let url = MICROBLOG_API;
      if (pagePermalink) {
        url += `?page_context=${encodeURIComponent(pagePermalink)}`;
      }
      
      const response = await fetch(url, { credentials: 'include' });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const data = await response.json();
      const microblogs = (data.posts || []).map(post => ({
        id: post.id,
        userName: post.username || 'Anonymous',
        timestamp: post.created_at,
        characterCount: post.content ? post.content.length : 0,
        topicPath: post.page_context || '',
        content: post.content
      }));
      
      const createIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="microblog-filter-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>`;
      const editIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="microblog-filter-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13l6.586-6.586a2 2 0 112.828 2.828L11.828 15.828a4 4 0 01-2.828 1.172H7v-2a4 4 0 011.172-2.828z" /></svg>`;
      
      const controlsInfo = `
        <span id="filter-icons" class="microblog-filter-controls">
          <button id="create-btn" class="microblog-btn microblog-btn-create" title="Create Post">${createIcon}</button>
        </span>
      `;
      
      const head = `
        <thead>
          <tr>
            <th style="width:30%">Analytics</th>
            <th>Message</th>
          </tr>
        </thead>
      `;
      
      let genBody = '';
      microblogs.forEach(post => {
        const analyticsCell = `
          <div>${post.userName}</div>
          <div>${new Date(post.timestamp).toLocaleString()}</div>
          <div>Count: ${post.characterCount}</div>
        `;
        
        const messageCell = `
          <div>Topic: ${post.topicPath} <button class='edit-btn ml-2' data-id='${post.id}' title='Edit'>${editIcon}</button></div>
          <div>${post.content}</div>
        `;
        
        genBody += `<tr id="post-row-${post.id}"><td class="text-left">${analyticsCell}</td><td class="text-left">${messageCell}</td></tr>`;
      });
      
      const body = `<tbody>${genBody}</tbody>`;
      
      container.innerHTML = `
        <div class="max-h-[70vh] overflow-y-auto">
          <table id="microblog-table" border="1" style="border-collapse:collapse; margin-top:1em; width:100%;">
            ${head}
            ${body}
          </table>
        </div>
      `;
      
      setTimeout(() => {
        if (window.jQuery && window.jQuery.fn.DataTable) {
          if (window.jQuery.fn.DataTable.isDataTable('#microblog-table')) {
            window.jQuery('#microblog-table').DataTable().destroy();
          }
          
          window.jQuery('#microblog-table').DataTable({
            initComplete: function() {
              const lengthDiv = document.querySelector('.dataTables_length');
              if (lengthDiv) {
                lengthDiv.style.display = 'flex';
                lengthDiv.style.alignItems = 'center';
                lengthDiv.insertAdjacentHTML('afterbegin', controlsInfo);
                const createBtn = document.getElementById('create-btn');
                if (createBtn) createBtn.onclick = () => openModal({ mode: 'create' });
              }
              
              const infoDiv = document.querySelector('.dataTables_info');
              if (infoDiv) {
                infoDiv.style.display = 'flex';
                infoDiv.style.alignItems = 'center';
                infoDiv.innerHTML = controlsInfo + infoDiv.innerHTML;
                const btns = infoDiv.querySelectorAll('#create-btn');
                btns.forEach(btn => btn.onclick = () => openModal({ mode: 'create' }));
              }
            }
          });
          
          window.jQuery('#microblog-table').on('click', '.edit-btn', function() {
            const id = window.jQuery(this).data('id');
            const post = microblogs.find(p => p.id == id);
            openModal({ mode: 'edit', post });
          });
        }
      }, 0);
      
    } catch (error) {
      container.innerHTML = `<div style="color:red;">Failed to load: ${error.message}</div>`;
    }
  }
  
  await renderMicroblogTable();
})();
</script>
